name: Tests (Pytest)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Useful extras for CI
          pip install pytest pytest-cov cryptography

      - name: Create .env for CI (SQLite) with valid Fernet key
        run: |
          # Generate a valid Fernet key (44-char urlsafe base64)
          FERNET_KEY=$(python - <<'PY'
          from cryptography.fernet import Fernet
          print(Fernet.generate_key().decode('utf-8'))
          PY
          )
          cat > .env << EOF
          SQLALCHEMY_DATABASE_URI=sqlite:///test.db
          SQLALCHEMY_TRACK_MODIFICATIONS=False
          SECRET_KEY=ci_test_secret_key
          MAIL_USERNAME=test@example.com
          MAIL_PASSWORD=dummy
          MAIL_FROM=test@example.com
          MAIL_PORT=587
          MAIL_SERVER=smtp.gmail.com
          MAIL_STARTTLS=True
          MAIL_SSL_TLS=False
          ADMIN_EMAIL=admin@onlycation.com
          ADMIN_PASSWORD=SuperSecreta123
          ADMIN_FIRST_NAME=Admin
          ADMIN_LAST_NAME=Onlycation
          ADMIN_ROLE=admin
          STRIPE_SECRET_KEY=sk_test_dummy
          STRIPE_PUBLIC_KEY=pk_test_dummy
          DOC_CIPHER_KEY=dummy_cipher_key
          # Both names to satisfy any import sites
          EVIDENCE_KEY=$FERNET_KEY
          EVIDENCE_ENCRYPTION_KEY=$FERNET_KEY
          YOUTUBE_API_KEY=
          LINKEDIN_CLIENT_ID=
          LINKEDIN_CLIENT_SECRET=
          LINKEDIN_REDIRECT_URI=http://localhost:8000/api/auth/linkedin/callback
          EOF
          echo "Created .env for CI (keys redacted):"
          cat .env | sed 's/^\(.*PASSWORD\|.*SECRET\|.*KEY\)=.*/\1=***REDACTED***/'

      - name: Run pytest with coverage
        env:
          # Ensure local .env is used by pydantic-settings
          Pydantic_env_file: .env
        run: |
          pytest -v --maxfail=1 --disable-warnings \
            --cov=app --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --junitxml=pytest-junit.xml

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-reports
          path: |
            coverage.xml
            pytest-junit.xml
            .coverage